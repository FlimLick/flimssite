<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manual WebRTC P2P Chat (Compressed Base64 Bundles)</title>

  <!-- Compression library (public CDN, no upkeep) -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; max-width: 980px; }
    h1 { margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fafafa; }
    label { display:block; font-size: 12px; opacity: 0.75; margin: 10px 0 4px; }
    textarea {
      width: 100%;
      min-height: 120px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      padding: 10px;
      box-sizing: border-box;
    }
    input, button { padding: 10px; font-size: 14px; }
    button { cursor: pointer; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    #log {
      height: 260px;
      overflow:auto;
      border:1px solid #ddd;
      border-radius: 10px;
      padding:10px;
      background:#fff;
      white-space: pre-wrap;
    }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:12px; }
  </style>
</head>
<body>

<h1>Manual WebRTC P2P Chat</h1>
<div class="row">
  <span class="pill" id="status">idle</span>
  <span>Public STUN only · No servers · Compressed base64 bundles</span>
</div>

<div class="grid" style="margin-top: 12px;">
  <div class="card">
    <h3>Caller</h3>
    <div class="row">
      <button id="createOfferBtn">Create Offer</button>
      <button id="applyAnswerBtn" disabled>Apply Answer</button>
    </div>

    <label>Offer (copy)</label>
    <textarea id="offerOut" readonly></textarea>

    <label>Paste Answer</label>
    <textarea id="answerIn"></textarea>
  </div>

  <div class="card">
    <h3>Joiner</h3>
    <button id="applyOfferBtn">Apply Offer & Create Answer</button>

    <label>Paste Offer</label>
    <textarea id="offerIn"></textarea>

    <label>Answer (copy)</label>
    <textarea id="answerOut" readonly></textarea>
  </div>
</div>

<div class="card" style="margin-top: 12px;">
  <h3>Chat</h3>
  <div id="log"></div>
  <div class="row" style="margin-top: 10px;">
    <input id="msg" placeholder="message…" style="flex:1">
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const logEl = $("log");
  const statusEl = $("status");

  function log(m) {
    logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function setStatus(s) { statusEl.textContent = s; }

  /* ---------- Compression helpers ---------- */
  function encodeBundle(obj) {
    const json = JSON.stringify(obj);
    const compressed = pako.gzip(json);
    return btoa(String.fromCharCode(...compressed))
      .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
  }

  function decodeBundle(str) {
    const bin = atob(str.replace(/-/g, "+").replace(/_/g, "/"));
    const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
    return JSON.parse(pako.ungzip(bytes, { to: "string" }));
  }

  /* ---------- WebRTC ---------- */
  const rtcConfig = {
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" },
      { urls: "stun:stun1.l.google.com:19302" },
      { urls: "stun:stun.cloudflare.com:3478" }
    ]
  };

  let pc = null;
  let dc = null;
  let localCandidates = [];
  let role = null;

  function reset() {
    if (dc) dc.close();
    if (pc) pc.close();
    pc = dc = null;
    localCandidates = [];
    role = null;
    $("sendBtn").disabled = true;
    $("applyAnswerBtn").disabled = true;
    setStatus("idle");
  }

  function ensurePC() {
    if (pc) return pc;
    pc = new RTCPeerConnection(rtcConfig);
    localCandidates = [];

    pc.onicecandidate = e => {
      if (e.candidate) localCandidates.push(e.candidate.toJSON());
    };

    pc.onconnectionstatechange = () => {
      setStatus(pc.connectionState);
      if (pc.connectionState === "connected") $("sendBtn").disabled = false;
    };

    pc.ondatachannel = e => {
      dc = e.channel;
      wireDC();
    };
    return pc;
  }

  function wireDC() {
    dc.onopen = () => log("DataChannel open");
    dc.onmessage = e => log("peer: " + e.data);
    dc.onclose = () => log("DataChannel closed");
  }

function waitIce(pc) {
  if (pc.iceGatheringState === "complete") return Promise.resolve();

  return new Promise(resolve => {
    const check = () => {
      if (pc.iceGatheringState === "complete") {
        pc.removeEventListener("icegatheringstatechange", check);
        resolve();
      }
    };
    pc.addEventListener("icegatheringstatechange", check);
  });
}

  function makeBundle(desc) {
    return encodeBundle({
      v: 1,
      description: desc,
      candidates: localCandidates
    });
  }

  function parseBundle(text) {
    const obj = decodeBundle(text.trim());
    if (!obj.description) throw "invalid bundle";
    return obj;
  }

  /* ---------- Caller ---------- */
  $("createOfferBtn").onclick = async () => {
    reset();
    role = "caller";
    setStatus("creating-offer");

    const pc = ensurePC();
    dc = pc.createDataChannel("chat");
    wireDC();

    await pc.setLocalDescription(await pc.createOffer());
    await waitIce(pc);

    $("offerOut").value = makeBundle(pc.localDescription);
    $("applyAnswerBtn").disabled = false;
    setStatus("offer-ready");
    log("Offer ready");
  };

  $("applyAnswerBtn").onclick = async () => {
    if (role !== "caller") return;
    const bundle = parseBundle($("answerIn").value);
    await pc.setRemoteDescription(bundle.description);
    for (const c of bundle.candidates) {
      try { await pc.addIceCandidate(c); } catch {}
    }
    setStatus("connecting");
  };

  /* ---------- Joiner ---------- */
  $("applyOfferBtn").onclick = async () => {
    reset();
    role = "joiner";
    setStatus("applying-offer");

    const bundle = parseBundle($("offerIn").value);
    const pc = ensurePC();

    await pc.setRemoteDescription(bundle.description);
    for (const c of bundle.candidates) {
      try { await pc.addIceCandidate(c); } catch {}
    }

    await pc.setLocalDescription(await pc.createAnswer());
    await waitIce(pc);

    $("answerOut").value = makeBundle(pc.localDescription);
    setStatus("answer-ready");
    log("Answer ready");
  };

  /* ---------- Chat ---------- */
  $("sendBtn").onclick = () => {
    if (!dc || dc.readyState !== "open") return;
    dc.send($("msg").value);
    log("me: " + $("msg").value);
    $("msg").value = "";
  };

  log("Flow:");
  log("1) Caller: Create Offer → copy");
  log("2) Joiner: Paste Offer → Create Answer → copy");
  log("3) Caller: Paste Answer → connect");
</script>

</body>
</html>
